<html>
  <head>
    <style>
      ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      li.item {
        border: var(--homey-line-light);
        border-radius: var(--homey-border-radius-default);
        background-color: var(--homey-color-mono-100);
        padding: var(--homey-su-1) var(--homey-su-2) var(--homey-su-1);
      }
      li:not(:last-child) {
        margin-bottom: var(--homey-su-2);
      }
    </style>
  </head>

  <body class="homey-widget-full">
    <div id="container"></ul>

    <script type="text/javascript">
      const $container = document.getElementById('container');
      function onHomeyReady(Homey) {
        function reload() {
          Promise.resolve().then(async () => {
            const feed = await Homey.api('GET', '/', {})
            $container.innerHTML = '';
            if (feed.length === 0) {
              throw new Error('Geen open Taken ðŸŽ‰.');
            }
            const $items = document.createElement('ul');
            $container.appendChild($items);

            let height = 30;
            for (const item of Object.values(feed)) {
              if (height > 0) {
                height += 8;
              }
              height += 45;
              const $item = document.createElement('li');
              $item.classList.add('item');

              $title = document.createElement('p');
              $title.classList.add('homey-text-medium');
              $title.innerHTML = item.title;
              $item.appendChild($title);
              
              $body = document.createElement('p');
              $body.classList.add('homey-text-small-light');
              $body.innerHTML = timeSince(item.date);
              const $dateAttribute = document.createAttribute("data-date");
              $dateAttribute.value = item.date
              $body.setAttributeNode($dateAttribute);
              $item.appendChild($body);

              $item.addEventListener('click', async () => {
                Homey.hapticFeedback();
                await Homey.api('DELETE', '/' + item.identifier, {});
                // Homey.popup(item.link);
              });
              
              $items.appendChild($item);
            }

            Homey.setHeight(height);
          })
          .catch(err => {
            const $item = document.createElement('li');

            $title = document.createElement('p');
            $title.classList.add('homey-text-regular');
            $title.innerHTML = err.message;
            $container.appendChild($title);
            Homey.setHeight(20);
          })
          .finally();
        }

        Homey.on('didUpdateTasks', (event) => {
          console.log(event);
          reload();
        });

        Homey.ready();
        reload();
        setInterval(updateTime, 1000); 
      }

      function updateTime() {
        items = document.querySelectorAll("li");
        items.forEach(function(item,n) {
          console.log(n,item);
        });
      }

      function timeSince(date) {
        var seconds = Math.floor((new Date() - Date.parse(date)) / 1000);
        if (seconds == 0) {
          return "Just now";
        }

        var interval = seconds / 31536000;
        if (interval > 1) {
          return Math.floor(interval) + " years ago";
        }
        interval = seconds / 2592000;
        if (interval > 1) {
          return Math.floor(interval) + " months ago";
        }
        interval = seconds / 86400;
        if (interval > 1) {
          return Math.floor(interval) + " days ago";
        }
        interval = seconds / 3600;
        if (interval > 1) {
          return Math.floor(interval) + " hours ago";
        }
        interval = seconds / 60;
        if (interval > 1) {
          return Math.floor(interval) + " minutes ago";
        }
        return Math.floor(seconds) + " seconds ago";
      }
    </script>
  </body>
</html>